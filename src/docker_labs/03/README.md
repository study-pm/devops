# Lab #3: Create an image with COPY instruction
https://dockerlabs.collabnix.com//beginners/dockerfile/lab4_dockerfile_copy.html

The `COPY` instruction copies files or directories from source and adds them to the filesystem of the container at destination.

Two form of `COPY` instruction
```sh
COPY [--chown=<user>:<group>] <src>... <dest>
COPY [--chown=<user>:<group>] ["<src>",... "<dest>"] (this form is required for paths containing whitespace)
```

- [Assignment](#assignment)
- [Command Line Tools](#command-line-tools)
  - [Start the service](#start-the-service)
  - [Stop the service](#stop-the-service)
  - [Underlying commands](#underlying-commands)
    - [Pre-requisite](#pre-requisite)
    - [Create an image with `COPY` instruction](#create-an-image-with-copy-instruction)
      - [Create the *Dockerfile*](#create-the-dockerfile)
      - [Create the *index* file](#create-the-index-file)
      - [Build Docker Image](#build-docker-image)
      - [Staring the container](#staring-the-container)
      - [Checking index file](#checking-index-file)
    - [COPY instruction in Multi-stage Builds](#copy-instruction-in-multi-stage-builds)
      - [Create the *Dockerfile*](#create-the-dockerfile-1)
      - [Building Docker Image](#building-docker-image)
      - [Staring the container](#staring-the-container-1)
      - [Checking index file](#checking-index-file-1)
- [Troubleshooting / Utils / Trivia](#troubleshooting--utils--trivia)
  - [`permission denied` error](#permission-denied-error)
  - [`failed to read dockerfile` error](#failed-to-read-dockerfile-error)

## Assignment
- Create an image with `COPY` instruction
- `COPY` instruction in Multi-stage Builds

## Command Line Tools
There are two prime commands for managing (starting and stopping) the provided service.

### Start the service
The following command runs the full command sequence:
```sh
$ ./start
```

alternatively:
```sh
$ sh start
```

### Stop the service
The following command clears all of the output (removing all possible side-effects) generated by running the *start* command:
```sh
$ ./clear
```

alternatively:
```sh
$ sh clear
```

### Underlying commands
There are multiple underlying scripts used for building the service functions. The sections below describe the commands used for managing the provided service and building the necessary resources.

#### Pre-requisite
There should be the following files (committed) in your working directory:
- *build1.Dockerfile*
- *build2.Dockerfile*
- *index.html*

In case any of them missing, run the *[create.sh](./create.sh)* script before executing the *start* command.

#### Create an image with `COPY` instruction

Consists of two commands, both put into the *[create.sh](./create.sh)* file.

##### Create the *Dockerfile*
*Dockerfile*
```docker
FROM nginx:alpine
LABEL maintainer="Collabnix"

COPY index.html /usr/share/nginx/html/
ENTRYPOINT ["nginx", "-g", "daemon off;"]
```

##### Create the *index* file
Lets create the ***index.html*** file
```html
$ echo "Welcome to Dockerlabs !" > index.html
```

##### Build Docker Image
```sh
$ docker image build -t cpy:v1 .
```

Placed into *[build.sh](./build.sh)* with image name and Dockerfile name passed as positional parameters.

##### Staring the container
```sh
docker container run -d --rm --name myapp1 -p 80:80 cpy:v1
```

Placed into *[run.sh](./run.sh)*.

##### Checking index file
```sh
$ curl localhost
Welcome to Dockerlabs !
```

Placed into *[check.sh](./check.sh)*.

#### COPY instruction in Multi-stage Builds

##### Create the *Dockerfile*
*Dockerfile*
```docker
FROM alpine AS stage1
LABEL maintainer="Collabnix"
RUN echo "Welcome to Docker Labs!" > /opt/index.html

FROM nginx:alpine
LABEL maintainer="Collabnix"
COPY --from=stage1 /opt/index.html /usr/share/nginx/html/
ENTRYPOINT ["nginx", "-g", "daemon off;"]
```

Placed into *[create.sh](./create.sh)*.

##### Building Docker Image
```sh
$ docker image build -t cpy:v2 .
```

Placed into *[build.sh](./build.sh)* with image name and Dockerfile name passed as positional parameters.

##### Staring the container
```sh
$ docker container run -d --rm --name myapp2 -p 8080:80 cpy:v2
```

##### Checking index file
```sh
$ curl localhost:8080
Welcome to Docker Labs !
```

Placed into *[check.sh](./check.sh)*.

> **NOTE:** You can name your stages, by adding an `AS` to the `FROM` instruction.By default, the stages are not named, and you can refer to them by their integer number, starting with 0 for the first `FROM` instruction.You are not limited to copying from stages you created earlier in your Dockerfile, you can use the `COPY --from` instruction to copy from a separate image, either using the local image name, a tag available locally or on a Docker registry.

```docker
COPY --from=nginx:latest /etc/nginx/nginx.conf /nginx.conf
```

## Troubleshooting / Utils / Trivia

### `permission denied` error
If you get the *permission denied* error while building the service scripts, make the script file executable:
```sh
$ chmod +x start
```

or:
```
$ chmod u+x clear
```

### `failed to read dockerfile` error
If you get the *ERROR: failed to solve: failed to read dockerfile* error while running the service, probably you have your *Dockerfile* or other crucial static files missing. Run the *[create.sh](./create.sh)* script before executing the *start* command.
