# Lab #4: Build Command
https://dockerlabs.collabnix.com/intermediate/workshop/DockerCompose/config_command.html

- [Overview](#overview)
- [Command instructions](#command-instructions)
  - [build](#build)
- [Quick Notes](#quick-notes)
  - [`build`](#build-1)
- [Pre-requisite](#pre-requisite)
- [Assignment](#assignment)
- [Setup environment](#setup-environment)
- [Command Line Tools](#command-line-tools)
  - [Start the service](#start-the-service)
  - [Stop the service](#stop-the-service)
  - [Underlying commands](#underlying-commands)
    - [Create Dockerfile](#create-dockerfile)
    - [Create a docker-compose.yml file](#create-a-docker-composeyml-file)
    - [Build the image using `docker-compose`](#build-the-image-using-docker-compose)
    - [Check the image have created](#check-the-image-have-created)
- [Utils / Trivia](#utils--trivia)
  - [Compose](#compose)
    - [Config](#config)
    - [Build](#build-2)
  - [Images](#images)
    - [Build image](#build-image)
    - [Browse image history](#browse-image-history)
    - [Remove images](#remove-images)
  - [Containers](#containers)
    - [Create (run) a container](#create-run-a-container)
    - [List containers](#list-containers)
    - [Exit the container shell](#exit-the-container-shell)
    - [Remove containers](#remove-containers)
    - [Remove a container](#remove-a-container)
    - [Force-remove a running container (`--force`)](#force-remove-a-running-container---force)
    - [Remove all stopped containers](#remove-all-stopped-containers)
  - [Volumes](#volumes)
    - [Create a volume](#create-a-volume)
    - [List volumes](#list-volumes)
    - [Inspect volume](#inspect-volume)
    - [Remove volumes](#remove-volumes)
- [Troubleshooting](#troubleshooting)
  - [Fix `permission denied` error](#fix-permission-denied-error)
  - [Fix `failed to read dockerfile` error](#fix-failed-to-read-dockerfile-error)
  - [Fix `docker-compose` error](#fix-docker-compose-error)

## Overview
In this lab we are going to look into **`docker-compose build`** command. Docker build used to create a new image using the instructions in the Dockerfile. The **build** can be specified either as a string containing a path to the build context. The newly built image will be used to create the container for the service.

## Command instructions

### build
The format is:
```docker
docker-compose build [options] [SERVICE…]
```

Build (rebuild) the service container in the project.

Once the service container is built, it will be tagged with a tagname, such as a db container in a web project, possibly *web_db*.

You can rebuild the service at any time by running the `docker-compose build` in the project directory.

Options include:

- `--force-rm` removes the temporary container during the build process.

- `--no-cache` does not use cache during the build image process (this will lengthen the build process).

- `--pull` always tries to get a mirror of the updated version by `--pull`.


## Quick Notes

### `build`
This property inside the `docker-compose.yml` file specifies the path to the folder where the Dockerfile is located (either an absolute path or a path relative to the docker-compose.yml file). Compose will use it to automatically build this image and then use this image.
```yml
 version: '3' services:  webapp:  build: ./dir
```
You can also use the context directive to specify the path to the folder where the *Dockerfile* is located.

Use the dockerfile directive to specify the *Dockerfile* filename.

Use the arg directive to specify the variables when the image is built.
```yml
 version: '3' services:  webapp:  build:  context: ./dir  dockerfile: Dockerfile-alternate  args:  buildno: 1
```

Use `cache_from` specify the cache to build the image
```yaml
 build:  context: .  cache_from:  - alpine: latest  - corp/web_app: 3.14
```

## Pre-requisite
- Install Docker Engine or Docker Desktop
- Install Docker Compose or Compose plugin for Docker

## Assignment
- We are going to build an nginx image with custome page.

## Setup environment
```sh
$ mkdir -p docker-compose/build
$ cd docker-compose/build
```

## Command Line Tools
There are two prime commands for managing (starting and stopping) the provided service.

### Start the service
The following command runs the full command sequence:
```sh
$ ./start
```

alternatively:
```sh
$ sh start
```

### Stop the service
The following command clears all of the output (removing all possible side-effects) generated by running the *start* command:
```sh
$ ./clear
```

alternatively:
```sh
$ sh clear
```

### Underlying commands
There are multiple underlying scripts used for building the service functions. The sections below describe the commands used for managing the provided service and building the necessary resources.

#### Create Dockerfile
Now lets create the Dockerfile
```docker
FROM nginx:alpine
RUN echo "Welcome to Docker Workshop!" >/usr/share/nginx/html/index.html
CMD ["nginx", "-g", "daemon off;"]
```

#### Create a docker-compose.yml file
*docker-compose.yml*:
```yaml
version: "3.7"
services:
  webapp:
    build:
      context: .
      dockerfile: Dockerfile
    image: webapp:v1
```

- **`context`**: To specify the build context directory that is sent to the Docker daemon.
- **`dockerfile`**: use to specify Alternate Dockerfile or path to Dockerfile.

#### Build the image using `docker-compose`
```sh
$ docker-compose build
```

Since we specified **`image`**: as well as **`build:`**, then the Compose built the image with name **`webapp`** and tag **`v1`**.

If we didnt specify the **`image:`** option the image name will be **`buid_:latest`**.

#### Check the image have created
```sh
$ docker image ls webapp:v1
```

## Utils / Trivia

### Compose

#### Config
Renders the actual data model to be applied on the Docker Engine. It merges the Compose files set by `-f` flags, resolves variables in the Compose file, and expands short-notation into the canonical format.

```sh
$ docker compose config
```

#### Build
Build (rebuild) the service container in the project. Services are built once and then tagged, by default as `project-service`.

If the Compose file specifies an image name, the image is tagged with that name, substituting any variables beforehand. See [variable interpolation](https://github.com/compose-spec/compose-spec/blob/master/spec.md#interpolation).

If you change a service's *Dockerfile* or the contents of its build directory, run `docker compose build` to rebuild it.

The format is:
```sh
docker compose build [options] [SERVICE…]
```

Once the service container is built, it will be tagged with a tagname, such as a db container in a web project, possibly *web_db*.

You can rebuild the service at any time by running the `docker-compose build` in the project directory.

Options include:

- `--force-rm` removes the temporary container during the build process.

- `--no-cache` does not use cache during the build image process (this will lengthen the build process).

- `--pull` always tries to get a mirror of the updated version by `--pull`.

### Images

#### Build image
```sh
$ docker image build -t <tag> .
$ docker build -t <tag> . -f <dockerfile-name>
```

#### Browse image history
```sh
$ docker image history <image>

#### List images
```sh
# Lists all images
$ docker images
$ docker image ls

# List a specific image
$ docker images <image>
$ docker image ls <image>
$ docker images | grep "keyword(s)"
```

#### Remove images
Below are the three command aliases:
```sh
$ docker image remove <image>
$ docker image rm <image>
$ docker rmi <image>
```

### Containers

#### Create (run) a container
```sh
$ docker container run <image>
$ docker run <image>
```

#### List containers
```sh
# List running containers
$ docker ps
$ docker container ls

# Lists all (running and stopped) containers
$ docker ps -a
```

#### Exit the container shell
Press <kbd>Ctrl</kbd> + <kbd>c</kbd> to exit the container shell. This stops the running container.

If you want to detach from a container without stopping it, type <kbd>Ctrl</kbd> + <kbd>p</kbd> then <kbd>Ctrl</kbd> + <kbd>q</kbd>. It will help you to turn interactive mode to daemon mode.

#### Remove containers
https://docs.docker.com/reference/cli/docker/container/rm/

#### Remove a container
This removes the container referenced under the link `/redis`.
```sh
$ docker rm /redis

/redis
```

#### Force-remove a running container (`--force`)
This command force-removes a running container.
```sh
$ docker rm --force redis

redis
```

The main process inside the container referenced under the link `redis` will receive `SIGKILL`, then the container will be removed.

#### Remove all stopped containers
Use the [`docker container prune`](https://docs.docker.com/reference/cli/docker/container/prune/) command to remove all stopped containers, or refer to the [`docker system prune`](https://docs.docker.com/reference/cli/docker/system/prune/) command to remove unused containers in addition to other Docker resources, such as (unused) images and networks.

Alternatively, you can use the `docker ps` with the `-q` / `--quiet` option to generate a list of container IDs to remove, and use that list as argument for the `docker rm` command.

Combining commands can be more flexible, but is less portable as it depends on features provided by the shell, and the exact syntax may differ depending on what shell is used. To use this approach on Windows, consider using PowerShell or Bash.

The example below uses `docker ps -q` to print the IDs of all containers that have exited (`--filter status=exited`), and removes those containers with the `docker rm` command:
```sh
$ docker rm $(docker ps --filter status=exited -q)
```

Or, using the `xargs` Linux utility:
```sh
$ docker ps --filter status=exited -q | xargs docker rm
```

### Volumes
https://docs.docker.com/reference/cli/docker/volume/

Manage volumes. Usage: `docker volume COMMAND`

#### Create a volume
```sh
$ docker volume create
```

#### List volumes

```sh
$ docker volume ls
```

Show names and mount point destinations of volumes used by a container:
https://stackoverflow.com/questions/30133664/how-do-you-list-volumes-in-docker-containers

```sh
$ docker container inspect \
 -f '{{ range .Mounts }}{{ .Name }}:{{ .Destination }} {{ end }}' \
 <CONTAINER_ID_OR_NAME>
```

#### Inspect volume

```sh
$ docker volume inspect
```

#### Remove volumes
Remove unused local volumes:
```sh
# With confirmation dialogue
$ docker volume prune

# Without confirmation
$ docker volume prune -f
```

Remove one or more volumes:
```sh
$ docker volume rm <volumes>
```

## Troubleshooting

### Fix `permission denied` error
If you get the *permission denied* error while building the service scripts, make the script file executable:
```sh
$ chmod +x start
```

or:
```
$ chmod u+x clear
```

### Fix `failed to read dockerfile` error
If you get the *ERROR: failed to solve: failed to read dockerfile* error while running the service, probably you have your *Dockerfile* or other crucial static files missing. Run the *[create.sh](./create.sh)* script before executing the *start* command.

### Fix `docker-compose` error
If you get the `Command 'docker-compose' not found, but can be installed with: sudo apt install docker-compose`, try running the same command as `docker compose` (without hyphen in between the words). If you wish to use `docker-compose` instead of `docker compose`, install a cli running a suggested command:
```sh
sudo apt install docker-compose
```

The `docker compose` (with a space) is a newer project to migrate compose to Go with the rest of the docker project. This is the v2 branch of the docker/compose repo. It's been first introduced to Docker Desktop users, so docker users on Linux didn't see the command. In addition to migrating to Go, it uses the compose-spec, and part of the rewrite may result in behavior differences.

The original python project, called `docker-compose`, aka v1 of docker/compose repo, has now been deprecated and development has moved over to v2. To install the v2 docker compose as a CLI plugin on Linux, supported distribution can now install the docker-compose-plugin package. E.g. on debian, I run `apt-get install docker-compose-plugin`.

Linux installs have been updated by Docker to include compose v2 and docker-compose v1 is unlikely to receive any more updates.

https://stackoverflow.com/questions/66514436/difference-between-docker-compose-and-docker-compose
